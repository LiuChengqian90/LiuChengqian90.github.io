<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css"><meta name="hexo-config" content="{&quot;hostname&quot;:&quot;chengqian90.com&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;algolia&quot;:{&quot;appID&quot;:&quot;AF7ILS3DFM&quot;,&quot;apiKey&quot;:&quot;d6766fc778aa1a2b67445c7a40b5dc75&quot;,&quot;indexName&quot;:&quot;hexo_github&quot;,&quot;hits&quot;:{&quot;per_page&quot;:10}}}"><meta name="description" content="简介Daemontools是svscanboot，svscan，supervise，svc，svok，svstat等一系列工具的合集。其中，supervise是其中的核心工具。 对于使用Daemontools的优点可以参考Service creation。"><meta property="og:type" content="article"><meta property="og:title" content="进程监控之daemontools"><meta property="og:url" content="http://chengqian90.com/Linux%E5%B7%A5%E5%85%B7/%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%B9%8Bdaemontools.html"><meta property="og:site_name" content="小刘的杂货铺"><meta property="og:description" content="简介Daemontools是svscanboot，svscan，supervise，svc，svok，svstat等一系列工具的合集。其中，supervise是其中的核心工具。 对于使用Daemontools的优点可以参考Service creation。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://chengqian90.com/images/%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%B9%8Bdaemontools/initab%E6%96%87%E4%BB%B6.png"><meta property="article:published_time" content="2018-04-08T02:24:29.000Z"><meta property="article:modified_time" content="2022-03-08T16:23:40.433Z"><meta property="article:author" content="Chengqian"><meta property="article:tag" content="supervise"><meta property="article:tag" content="svscan"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://chengqian90.com/images/%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%B9%8Bdaemontools/initab%E6%96%87%E4%BB%B6.png"><link rel="canonical" href="http://chengqian90.com/Linux%E5%B7%A5%E5%85%B7/%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%B9%8Bdaemontools.html"><meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;}"><meta name="hexo-config-calendar" content=""><title>进程监控之daemontools | 小刘的杂货铺</title><script data-pjax src="/js/load-config.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-119899037-1"></script><script>if(CONFIG.hostname===location.hostname){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-119899037-1")}</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9b18612675d198048222a1c96dd7555";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="小刘的杂货铺" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">小刘的杂货铺</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">In order to be irreplaceable, one must always be different</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-top"><a href="/top/" rel="section"><i class="fa fa-signal fa-fw"></i>top</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svscanboot"><span class="nav-number">3.</span> <span class="nav-text">svscanboot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-rc-local"><span class="nav-number">3.1.</span> <span class="nav-text">&#x2F;etc&#x2F;rc.local</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-inittab"><span class="nav-number">3.2.</span> <span class="nav-text">&#x2F;etc&#x2F;inittab</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-event-d-version-1"><span class="nav-number">3.3.</span> <span class="nav-text">&#x2F;etc&#x2F;event.d version 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-event-d-version-2"><span class="nav-number">3.4.</span> <span class="nav-text">&#x2F;etc&#x2F;event.d version 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etc-init"><span class="nav-number">3.5.</span> <span class="nav-text">&#x2F;etc&#x2F;init</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svscan"><span class="nav-number">4.</span> <span class="nav-text">svscan</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">4.1.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#supervise"><span class="nav-number">5.</span> <span class="nav-text">supervise</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E5%8E%9F%E7%90%86"><span class="nav-number">5.1.</span> <span class="nav-text">工具原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%EF%BC%88%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8svscan%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F%EF%BC%89"><span class="nav-number">5.2.</span> <span class="nav-text">测试（直接使用svscan测试程序）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">5.3.</span> <span class="nav-text">使用的文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svc"><span class="nav-number">6.</span> <span class="nav-text">svc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="nav-number">6.1.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svok"><span class="nav-number">7.</span> <span class="nav-text">svok</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svstat"><span class="nav-number">8.</span> <span class="nav-text">svstat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="nav-number">8.1.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fghack"><span class="nav-number">9.</span> <span class="nav-text">fghack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pgrphack"><span class="nav-number">10.</span> <span class="nav-text">pgrphack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E7%A7%80%E8%B5%84%E6%96%99"><span class="nav-number">11.</span> <span class="nav-text">优秀资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Chengqian</p><div class="site-description" itemprop="description">内核/云计算/网络</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">94</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">149</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://chengqian90.com/Linux%E5%B7%A5%E5%85%B7/%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%B9%8Bdaemontools.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Chengqian"><meta itemprop="description" content="内核/云计算/网络"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小刘的杂货铺"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 进程监控之daemontools</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-04-08 10:24:29" itemprop="dateCreated datePublished" datetime="2018-04-08T10:24:29+08:00">2018-04-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-03-09 00:23:40" itemprop="dateModified" datetime="2022-03-09T00:23:40+08:00">2022-03-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">Linux工具</span></a></span></span><span id="/Linux%E5%B7%A5%E5%85%B7/%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%B9%8Bdaemontools.html" class="post-meta-item leancloud_visitors" data-flag-title="进程监控之daemontools" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>5.7k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>5 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Daemontools是svscanboot，svscan，supervise，svc，svok，svstat等一系列工具的合集。其中，<code>supervise</code>是其中的核心工具。</p><p>对于使用Daemontools的优点可以参考<a target="_blank" rel="noopener" href="http://cr.yp.to/daemontools/faq/create.html#why">Service creation</a>。</p><span id="more"></span><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>参考<a target="_blank" rel="noopener" href="https://cr.yp.to/daemontools.html">官网教程</a> 及 <a target="_blank" rel="noopener" href="https://linux.cn/man/man8/svscanboot.8.html">Linux命令帮助</a>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir -p /package</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chmod 1755 /package		//设置粘贴位</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /package</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> wget  https://cr.yp.to/daemontools/daemontools-0.76.tar.gz</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tar zxvf daemontools-0.76.tar.gz</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> admin/daemontools-0.76/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> package/install</span></span><br></pre></td></tr></table></figure><p>若上一步出错，错误信息如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Linking ./src/* into ./compile...</span><br><span class="line">Compiling everything in ./compile...</span><br><span class="line">./load envdir unix.a byte.a </span><br><span class="line">/usr/bin/ld: errno: TLS definition in /lib64/libc.so.6 section .tbss mismatches non-TLS reference in envdir.o</span><br><span class="line">/lib64/libc.so.6: error adding symbols: Bad value</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">make: *** [envdir] Error 1</span><br></pre></td></tr></table></figure><p>解决方案</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将admin/daemontools-0.76/src/error.h中的extern int errno; 替换为 #include &lt;errno.h&gt;</span><br></pre></td></tr></table></figure><p>验证安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /etc/inittab 	//查看是否有svscanboot，需重启以启动svscan</span></span><br></pre></td></tr></table></figure><p><img src="/images/%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%B9%8Bdaemontools/initab%E6%96%87%E4%BB%B6.png" alt="initab文件"></p><h2 id="svscanboot"><a href="#svscanboot" class="headerlink" title="svscanboot"></a>svscanboot</h2><p><code>svscanboot</code>是<code>svscan</code>的开机启动程序。</p><p>有几种不同的方式来运行<code>svscanboot</code>命令，启动<code>svscan</code>。unix / linux发行版继续使用它们的启动系统，打破了与现有启动脚本的兼容性。</p><h3 id="etc-rc-local"><a href="#etc-rc-local" class="headerlink" title="/etc/rc.local"></a>/etc/rc.local</h3><p>将下行加入文件<code>/etc/rc.local</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">csh -cf &#x27;/command/svscanboot &amp;&#x27;</span><br></pre></td></tr></table></figure><p>这是传统的方法。</p><h3 id="etc-inittab"><a href="#etc-inittab" class="headerlink" title="/etc/inittab"></a>/etc/inittab</h3><p>将下行加入文件<code>/etc/inittab</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SV:12345:respawn:/command/svscanboot</span><br></pre></td></tr></table></figure><p>这是传统的System V方法，并且几乎在Linux系统中得到普遍支持多年，但被Ubuntu 6.10所破坏。</p><h3 id="etc-event-d-version-1"><a href="#etc-event-d-version-1" class="headerlink" title="/etc/event.d version 1"></a>/etc/event.d version 1</h3><p>将以下几行加入文件<code>/etc/event.d/svscan</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">start on runlevel-1</span><br><span class="line">start on runlevel-2</span><br><span class="line">start on runlevel-3</span><br><span class="line">start on runlevel-4</span><br><span class="line">start on runlevel-5</span><br><span class="line">respawn /command/svscanboot</span><br></pre></td></tr></table></figure><p>Ubuntu 6.10以下版本可用。</p><h3 id="etc-event-d-version-2"><a href="#etc-event-d-version-2" class="headerlink" title="/etc/event.d version 2"></a>/etc/event.d version 2</h3><p>将以下几行加入文件<code>/etc/event.d/svscan</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">start on runlevel 1</span><br><span class="line">start on runlevel 2</span><br><span class="line">start on runlevel 3</span><br><span class="line">start on runlevel 4</span><br><span class="line">start on runlevel 5</span><br><span class="line">respawn</span><br><span class="line">exec /command/svscanboot</span><br></pre></td></tr></table></figure><p>Ubuntu 7.04 到 9.04 可用。</p><h3 id="etc-init"><a href="#etc-init" class="headerlink" title="/etc/init"></a>/etc/init</h3><p>将以下几行加入文件<code>/etc/init/svscan.conf</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start on runlevel [12345]</span><br><span class="line">stop on runlevel [^12345]</span><br><span class="line">respawn</span><br><span class="line">exec /command/svscanboot</span><br></pre></td></tr></table></figure><p>Ubuntu 9.10 到 (至少) 11.10 之间可用。</p><h2 id="svscan"><a href="#svscan" class="headerlink" title="svscan"></a>svscan</h2><p><code>svscan</code>启动并监视一组服务。</p><p><code>svscan</code>为当前目录的每个子目录启动一个监控进程，最多可达1000个子目录。<code>svscan</code>跳过以点开始的子目录名称。监控必须在<code>svscan</code>的path上。</p><p>每个子目录下都会有一个名为<code>run</code>的用来启动对应服务的脚本程序。<code>supervise</code>会监控该服务，在服务消亡时使用<code>run</code>脚本来自动启动该服务。</p><p><code>svscan</code>可以选择启动<strong>一对</strong>监控进程，一个用于子目录<code>s</code>，一个用于<code>s/log</code>，并在它们之间建立一个管道。如果<code>s</code>最长为255个字节并且<code>s/log</code>存在，它会执行此操作。（在版本0.70和更低版本中，如果粘滞位（sticky bit）被置位，它会执行此操作。）<code>svscan</code>的每个管道需要两个空闲的文件描述符。</p><p>每隔5秒钟，<code>svscan</code>再次检查子目录。如果它看到一个新的子目录，它会启动一个新的监控过程。如果它看到监控进程退出的旧子目录，则重新启动监控进程。在日志情况下，它重新使用相同的管道，以避免数据丢失。</p><p><code>svscan</code>被设计为永远运行。如果在创建管道或运行监督时遇到困难，则会向stderr发送消息;它会在五秒钟后再试一次。</p><p>如果<code>svscan</code>被赋予一个命令行参数，它将在启动时切换到该目录。</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ol><li><p>目录创建</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /root</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir services;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> services;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir test1 test2;</span></span><br></pre></td></tr></table></figure></li><li><p>程序创建</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> test1;</span></span><br></pre></td></tr></table></figure><p>创建<code>test1.c</code>文件，代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;in process test 1\n&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> gcc -o test1 test1.c</span></span><br></pre></td></tr></table></figure></li><li><p>创建<strong>可执行</strong>文件<code>run</code>（chmod +x run）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo &quot;start test 1 !&quot;</span><br><span class="line">exec ./test1</span><br></pre></td></tr></table></figure></li><li><p>test2中文件类似test1中创建。</p></li><li><p><code>svscan</code>运行。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svscan /root/services</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="supervise"><a href="#supervise" class="headerlink" title="supervise"></a>supervise</h2><p><code>supervise</code>是一种进程监控工具，其功能是当监控的指定进程消亡时，重启进程。</p><p>启用<code>supervise</code>监控服务比较容易，只需要添加一个被监控的服务的<strong>目录</strong>，在该目录中添加启动服务器的名字为run的脚本文件即可。<code>supervise</code>调用这个脚本，并监控管理该脚本中运行的程序。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">supervise s</span></span><br></pre></td></tr></table></figure><p><code>supervisor</code>是所有监控项目的父进程。</p><p>监控切换到名为<code>s</code>的目录并启动<code>./run</code>。如果<code>./run</code>退出，它会重新启动<code>./run</code>。它在启动<code>./run</code>后暂停一秒，以便在<code>./run</code>立即退出时不会太快地循环。</p><p>如果文件<code>s/down</code>存在，则监督不会立即开始<code>./run</code>。你可以使用<code>svc</code>来启动<code>./run</code>并提供其他命令来监控。</p><p>监控维护目录<code>s/supervise</code>中的二进制格式的状态信息，该目录必须是可写的，以便监控。状态信息可以通过<code>svstat</code>读取。</p><p>如果启动后监控无法找到它需要的文件，或者监控的另一个副本已经在<code>s</code>中运行，它可能立即退出。一旦监控成功运行，它不会退出，除非它被杀死或被特别要求退出。</p><p><strong>可以使用<code>svok</code>来检查监督是否成功运行。也可以使用<code>svscan</code>来可靠地启动一系列监控进程。</strong></p><h3 id="工具原理"><a href="#工具原理" class="headerlink" title="工具原理"></a>工具原理</h3><p><code>supervise</code>启动的时候fork一个子进程，子进程执行execvp系统调用，将自己替换成执行的模块。</p><p>模块变成<code>supervise</code>的子进程运行，而<code>supervise</code>则死循环运行，并通过waitpid或者wait3系统调用选择非阻塞的方式去侦听子进程的运行情况。同时也会读取pipe文件svcontrol的命令，然后根据命令去执行不同的动作。</p><p>如果子进程因某种原因导致退出，则<code>supervise</code>通过waitpid或者wait3获知，并继续启动模块，如果模块异常导致无法启动，则会使<code>supervise</code>陷入死循环，不断的启动模块。</p><h3 id="测试（直接使用svscan测试程序）"><a href="#测试（直接使用svscan测试程序）" class="headerlink" title="测试（直接使用svscan测试程序）"></a>测试（直接使用svscan测试程序）</h3><p>可直接使用<code>svscan</code>测试程序。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> supervise test1</span> </span><br></pre></td></tr></table></figure><p><code>test1</code>为目录。一般服务器运行的程序会将其挂起，如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nohup supervise <span class="built_in">test</span>/  &gt; /dev/null 2&gt;&amp;1 &amp; //nohup,no hang up</span></span><br></pre></td></tr></table></figure><h3 id="使用的文件"><a href="#使用的文件" class="headerlink" title="使用的文件"></a>使用的文件</h3><p><code>supervise</code>会在服务目录下创建名为<code>supervise</code>的目录，同时<code>supervise</code>目录下会有4个文件，分别为<code>control lock ok status</code>，对应的功能和我们可以从中获取的信息如下</p><ul><li><p>control</p><ul><li>可以理解为一个控制接口，supervise读取这个管道的信息，进而根据管道的信息去控制子进程，而通过控制子进程的方式实际上就是给子进程发信号。</li><li>可以利用的信息：直接写命令到该文件中，如echo ‘d’ &gt; svcontorl，让supervise去控制子进程，比较常用的命令如下<ul><li>d: <strong>停掉子进程</strong>，并且不启动。</li><li>u: 相对于d，<strong>启动子进程</strong>。</li><li>k: 发送一个kill信号，因kill之后supervise马上又<strong>重启</strong>，因此可以认为是一个重启的动作。</li><li>x: 标志supervise退出。</li></ul></li></ul></li><li><p>lock</p><ul><li>supervise的文件锁，通过该文件锁去控制并发，防止同一个status目录下启动多个进程，造成混乱。</li><li>可以通过/sbin/fuser这个命令去获取lock文件的使用信息，如果fuser返回值为0，表示supervise已经启动,同时fuser返回了<strong>supervise的进程pid</strong>。</li></ul></li><li><p>ok</p><ul><li>通过此文件判断supervise进程状态。</li></ul></li><li><p>status</p><ul><li><p>supervise用来记录一些信息之用，可以简单的理解为 char status[20]，其中status[16]记录了supervise所启动的子进程的pid，status[17]-status[19] 是子进程pid别右移8位，而status[0]-status[11] 没有用，status[12]-status[14] 是标志位，一般没啥用,status[15] 直接为0。</p></li><li><p>可以直接通过od命令去读取该文件,一般有用的就是od -An -j16 -N2 -tu2 status可以直接拿到 supervise所负责的子进程的pid。</p><p>如果用 od -d status 或 od -t u2 status 读取 2 字节，无符号短整型，最大值是 65535。如果 cat /proc/sys/kernel/pid_max 大于这个数。od -d status 读出来的 pid 就有可能是错的。每次右移 8 位，是想把 pid 保存成 4 字节。即从 16 - 19 共 4 个字节。正确的读取应该是 od -t u4 status，按 4 字节无符号整形读取就不会有问题了。</p></li></ul></li></ul><h2 id="svc"><a href="#svc" class="headerlink" title="svc"></a>svc</h2><p><code>svc</code>控制由<code>supervise</code>监控的服务。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svc opts services</span><br></pre></td></tr></table></figure><p><code>opts</code>是一系列<code>getopt</code>样式的选项。<code>sercies</code>由任意数量的参数组成，每个参数命名一个由<code>supervise</code>使用的目录。</p><p><code>svc</code>依次将所有选项应用于每个服务。这里是选项：</p><ul><li><code>-u</code>: Up。如果服务未运行，则启动。如果服务已停止，则重启。</li><li><code>-d</code>: Down。服务已运行，向服务发送<code>TERM</code>和<code>CONT</code>信号。停止之后，不在重启。</li><li><code>-o</code>: Once。服务未运行，启动。停止之后，不在重启。</li><li><code>-p</code>: Pause。向服务发送<code>STOP</code>信号。</li><li><code>-c</code>: Continue。向服务发送<code>CONT</code>信号。</li><li><code>-h</code>: Hangup。向服务发送<code>HUP</code>信号。</li><li><code>-a</code>: Alarm。向服务发送<code>ALRM</code>信号。</li><li><code>-i</code>: Interrupt。向服务发送<code>INT</code>信号。</li><li><code>-t</code>: Terminate。向服务发送<code>TERM</code>信号。</li><li><code>-k</code>: Kill。向服务发送<code>KILL</code>信号。</li><li><code>-x</code>: Exit。一旦服务关闭，<code>supervise</code>将立即退出。如果在一个稳定的系统上使用这个选项，监控可能永远运行。</li></ul><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>接<code>svscan</code>测试。</p><ol><li><p><code>-d</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svc -d /root/services/test1</span></span><br></pre></td></tr></table></figure><p><code>test1</code>停止，仅<code>test2</code>打印程序。<code>supervise test1</code>未停止。</p></li><li><p><code>-u</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svc -u /root/services/test1</span></span><br></pre></td></tr></table></figure><p><code>test1</code>重启。</p></li><li><p><code>-k</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svc -k /root/services/test1</span></span><br></pre></td></tr></table></figure><p><code>test1</code>重启。<code>test1</code>被kill之后，<code>supervise</code>会将其重启，可查看其进程号以确定。</p></li><li><p><code>-dx</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svc -dx /root/services/test1</span></span><br></pre></td></tr></table></figure><p>退出<code>test1</code> 及 <code>supervise test1</code>进程。<code>svscan</code>监听时会将<code>supervise test1</code>重新启动。</p></li></ol><h2 id="svok"><a href="#svok" class="headerlink" title="svok"></a>svok</h2><p><code>svok</code>检测<code>supervise</code>是否在运行。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svok service</span></span><br></pre></td></tr></table></figure><p><code>svok</code>检查<code>supervise</code>是否在名为<code>service</code>的目录中成功运行。如果<code>supervise</code>成功运行，它将以<code>0</code>为返回值退出。如果<code>supervise</code>没有成功运行，它将以<code>100</code>为返回值退出。</p><h2 id="svstat"><a href="#svstat" class="headerlink" title="svstat"></a>svstat</h2><p><code>svstat</code>打印由<code>supervise</code>监控的服务状态。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svstat services</span></span><br></pre></td></tr></table></figure><p><code>services</code>由任意数量的参数（目录）组成。<code>svstat</code>为每个目录打印一条可视化的行，说明<code>supervise</code>是否在该目录中成功运行，并报告由<code>supervise</code>维护的状态信息。</p><h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> svstat services/test1</span></span><br><span class="line">services/test1: up (pid 12587) 129 seconds</span><br><span class="line"><span class="meta">#</span><span class="bash"> svc -d services/test1</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> svstat services/test1</span></span><br><span class="line">services/test1: down 8 seconds, normally up</span><br></pre></td></tr></table></figure><h2 id="fghack"><a href="#fghack" class="headerlink" title="fghack"></a>fghack</h2><p><code>fghack</code>是一个<code>anti-backgrounding</code>的工具。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fghack child</span><br></pre></td></tr></table></figure><p><code>fghack</code>运行有许多额外描述符写入管道的子进程。<code>fghack</code>读取并丢弃任何写入管道的数据。在子进程退出且管道关闭后，<code>fghack</code>退出。</p><h2 id="pgrphack"><a href="#pgrphack" class="headerlink" title="pgrphack"></a>pgrphack</h2><p><code>pgrphack</code>会在一个单独的进程组中运行一个程序。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pgrphack child</span><br></pre></td></tr></table></figure><h2 id="优秀资料"><a href="#优秀资料" class="headerlink" title="优秀资料"></a>优秀资料</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012373815/article/details/70217030">supervise进程管理利器</a></p><p><a target="_blank" rel="noopener" href="http://linbo.github.io/2013/02/24/daemontools">进程的守护神 - daemontools</a></p><p><a target="_blank" rel="noopener" href="http://naixwf.github.io/2015/07/21/2014-11-19-daemontools/">用Daemontools监控Linux服务</a></p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/supervise/" rel="tag"># supervise</a> <a href="/tags/svscan/" rel="tag"># svscan</a></div><div class="post-nav"><div class="post-nav-item"><a href="/Linux%E5%B7%A5%E5%85%B7/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E4%B9%8Bsupervisor.html" rel="prev" title="进程管理之supervisor"><i class="fa fa-chevron-left"></i> 进程管理之supervisor</a></div><div class="post-nav-item"> <a href="/%E5%AE%B9%E5%99%A8/%E5%AD%A6%E4%B9%A0Kubernetes%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94%E6%89%A9%E5%B1%95.html" rel="next" title="title-name">title-name<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81MzIyNS8yOTcwMA=="></div><script src="/js/comments.js"></script></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18025897号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Chengqian</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.8.6/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.19.0/dist/instantsearch.production.min.js"></script><script src="/js/algolia-search.js"></script><script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      const visitors = document.querySelector('.leancloud_visitors');
      const url = decodeURI(visitors.id);
      const title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            const counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      const visitors = document.querySelectorAll('.leancloud_visitors');
      const entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            const target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    const { app_id, app_key, server_url } = {"enable":true,"app_id":"OxuGm1sftgvx1pybK4fNvWEI-gzGzoHsz","app_key":"wVNroDGKbkHDfo8jS43cWkzo","server_url":null,"security":false};
    function fetchData(api_server) {
      const Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    const api_server = app_id.slice(-9) === '-MdYXbMMI' ? `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com` : server_url;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script><script>
NexT.utils.loadComments('#lv-container', () => {
  window.livereOptions = {
    refer: "Linux工具/进程监控之daemontools.html"
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>