<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css"><meta name="hexo-config" content="{&quot;hostname&quot;:&quot;chengqian90.com&quot;,&quot;root&quot;:&quot;/&quot;,&quot;images&quot;:&quot;/images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;algolia&quot;:{&quot;appID&quot;:&quot;AF7ILS3DFM&quot;,&quot;apiKey&quot;:&quot;d6766fc778aa1a2b67445c7a40b5dc75&quot;,&quot;indexName&quot;:&quot;hexo_github&quot;,&quot;hits&quot;:{&quot;per_page&quot;:10}}}"><meta name="description" content="TCP连接状态一个TCP在其生命周期会历经多种状态。 状态的转换原因一是因为应用程序的主动，一是接收到网络请求的被动。"><meta property="og:type" content="article"><meta property="og:title" content="TCP状态机"><meta property="og:url" content="http://chengqian90.com/Linux%E5%86%85%E6%A0%B8/TCP%E7%8A%B6%E6%80%81%E6%9C%BA.html"><meta property="og:site_name" content="小刘的杂货铺"><meta property="og:description" content="TCP连接状态一个TCP在其生命周期会历经多种状态。 状态的转换原因一是因为应用程序的主动，一是接收到网络请求的被动。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://chengqian90.com/images/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/TCP%E7%8A%B6%E6%80%81%E6%9C%BA.png"><meta property="og:image" content="http://chengqian90.com/images/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png"><meta property="og:image" content="http://chengqian90.com/images/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/TCP%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png"><meta property="article:published_time" content="2019-11-19T07:13:52.000Z"><meta property="article:modified_time" content="2021-03-02T12:17:05.000Z"><meta property="article:author" content="Chengqian"><meta property="article:tag" content="TCP"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://chengqian90.com/images/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/TCP%E7%8A%B6%E6%80%81%E6%9C%BA.png"><link rel="canonical" href="http://chengqian90.com/Linux%E5%86%85%E6%A0%B8/TCP%E7%8A%B6%E6%80%81%E6%9C%BA.html"><meta name="hexo-config-page" content="{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;}"><meta name="hexo-config-calendar" content=""><title>TCP状态机 | 小刘的杂货铺</title><script data-pjax src="/js/load-config.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-119899037-1"></script><script>if(CONFIG.hostname===location.hostname){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-119899037-1")}</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9b18612675d198048222a1c96dd7555";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="小刘的杂货铺" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">小刘的杂货铺</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">In order to be irreplaceable, one must always be different</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-top"><a href="/top/" rel="section"><i class="fa fa-signal fa-fw"></i>top</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container"><div class="algolia-stats"><hr></div><div class="algolia-hits"></div><div class="algolia-pagination"></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81"><span class="nav-number">1.</span> <span class="nav-text">TCP连接状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="nav-number">2.</span> <span class="nav-text">三次握手</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="nav-number">3.</span> <span class="nav-text">四次挥手</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RST%E6%8A%A5%E6%96%87%E6%AE%B5"><span class="nav-number">4.</span> <span class="nav-text">RST报文段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%A0%E4%B8%AA%E7%96%91%E9%97%AE"><span class="nav-number">5.</span> <span class="nav-text">几个疑问</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="nav-number">5.1.</span> <span class="nav-text">为什么需要三次握手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="nav-number">5.2.</span> <span class="nav-text">为什么需要四次挥手</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%AD%89%E5%BE%852MSL"><span class="nav-number">5.3.</span> <span class="nav-text">为什么要等待2MSL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E7%A7%80%E8%B5%84%E6%96%99"><span class="nav-number">6.</span> <span class="nav-text">优秀资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Chengqian</p><div class="site-description" itemprop="description">内核/云计算/网络</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives"><span class="site-state-item-count">94</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">149</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://chengqian90.com/Linux%E5%86%85%E6%A0%B8/TCP%E7%8A%B6%E6%80%81%E6%9C%BA.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Chengqian"><meta itemprop="description" content="内核/云计算/网络"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小刘的杂货铺"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> TCP状态机</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-11-19 15:13:52" itemprop="dateCreated datePublished" datetime="2019-11-19T15:13:52+08:00">2019-11-19</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-03-02 20:17:05" itemprop="dateModified" datetime="2021-03-02T20:17:05+08:00">2021-03-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">Linux内核</span></a></span></span><span id="/Linux%E5%86%85%E6%A0%B8/TCP%E7%8A%B6%E6%80%81%E6%9C%BA.html" class="post-meta-item leancloud_visitors" data-flag-title="TCP状态机" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>3.8k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="TCP连接状态"><a href="#TCP连接状态" class="headerlink" title="TCP连接状态"></a>TCP连接状态</h2><p>一个TCP在其生命周期会历经多种状态。</p><p>状态的转换原因一是因为应用程序的主动，一是接收到网络请求的被动。</p><span id="more"></span><p><img src="/images/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/TCP%E7%8A%B6%E6%80%81%E6%9C%BA.png" alt="TCP状态机"></p><p>上图包含11种状态，分别对其进行描述</p><table><thead><tr><th>状态</th><th>描述</th></tr></thead><tbody><tr><td>CLOSED</td><td>关闭状态——初始状态</td></tr><tr><td></td><td></td></tr><tr><td>SYN_SENT</td><td>发送连接请求后等待来自远程端点的确认。TCP第一次握手后客户端所处的状态</td></tr><tr><td>ESTABLISHED</td><td>连接已建立。连接数据传输阶段的正常状态</td></tr><tr><td>FIN_WAIT_1</td><td>已发送FIN报文，正等待来自远程TCP的终止连接请求或终止请求的<strong>确认</strong></td></tr><tr><td>FIN_WAIT_2</td><td>FIN_WAIT1状态的TCP节点现在已经收到了对端TCP节点发来的ACK（半关闭状态）</td></tr><tr><td>TIME_WAIT</td><td>完成主动关闭后，TCP节点接收到了FIN报文。这表示对端执行了一个被动关闭。2MSL超时时间</td></tr><tr><td></td><td></td></tr><tr><td>LISTEN</td><td>TCP正等待从对端TCP节点发来的连接请求</td></tr><tr><td>SYN_REVD</td><td>该端点已经接收到连接请求并发送确认。</td></tr><tr><td>CLOSE_WAIT</td><td>该端点已经收到来自远程端点的关闭请求，此TCP正在等待本地应用程序的连接终止请求。</td></tr><tr><td>LAST_ACK</td><td>应用程序执行被动关闭，而之前处于CLOSE_WAIT状态的节点发送一个FIN报文给对端，并等待对端的确认。当收到对端发来的确认ACK报文时，连接关闭，相关的内核资源都会得到释放。</td></tr><tr><td>CLOSING</td><td>之前处在FIN_WAIT1状态的TCP节点正在等待对端发送ACK，但却收到了FIN。这表示对端也正在尝试执行一个主动关闭。（换句话说，这两个TCP节点几乎在同一时刻发送了FIN报文。即同时关闭）</td></tr></tbody></table><h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p><img src="/images/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="TCP三次握手"></p><ul><li>第一次握手：建立连接。<ul><li>客户端发送连接请求报文段，SYN置为1，Sequence Number为J;然后，客户端进入SYN_SEND状态，等待服务器的确认。</li></ul></li><li>第二次握手：服务器收到SYN报文段。<ul><li>服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为J+1(Sequence Number+1);</li><li>同时，服务器还要发送SYN请求信息，将SYN位置为1，SequenceNumber为K;服务器端将上述所有信息放到一个报文段(即SYN+ACK报文段)中，一并发送给客户端，此时服务器进入SYN_RECV状态。</li></ul></li><li>第三次握手：客户端收到服务器的SYN+ACK报文段。<ul><li>客户端将Acknowledgment Number设置为K+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。</li></ul></li></ul><h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p><img src="/images/TCP%E7%8A%B6%E6%80%81%E6%9C%BA/TCP%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png" alt="TCP四次挥手"></p><ul><li><p>第一次挥手：A端（客户端或服务器），设置Sequence Number和Acknowledgment Number，向B端发送一个FIN报文段。此时，A端进入FIN_WAIT_1状态，这表示A端没有数据要发送给主机2了。</p></li><li><p>第二次挥手：B端收到了A端发送的FIN报文段，向A端回一个ACK报文段，Acknowledgment Number为Sequence Number加1。A端收到ACK，进入FIN_WAIT_2状态。</p></li><li><p>第三次挥手：B端向A端发送FIN报文段，请求关闭连接，同时B端进入CLOSE_WAIT状态。</p></li><li><p>第四次挥手：A端收到B端发送的FIN报文段，向B端发送ACK报文段，然后A端进入TIME_WAIT状态。</p><p>B端收到A端的ACK报文段以后，就关闭连接。此时，A端<strong>等待2MSL</strong>后依然没有收到回复，则证明B端已正常关闭，那好，A端也可以关闭连接了。</p></li></ul><h2 id="RST报文段"><a href="#RST报文段" class="headerlink" title="RST报文段"></a>RST报文段</h2><p>无论何时一个报文段发往基准的连接出现错误，TCP都会发出一个复位报文段。</p><p>基准的连接：指由目的IP地址和端口号以及源IP地址和端口号指明的连接。</p><p>RST报文段，接收方不会进行确认。收到RST的一方将终止该连接，并通知应用层连接复位。</p><p><strong>应用场合：</strong></p><ol><li><p>到不存在的端口的连接请求：服务器程序端口未打开而客户端来连接。比如主机1向主机2发送一个SYN请求，表示想要连接主机2的40000端口，但是主机2上根本没有打开40000这个端口，于是就向主机1发送了一个RST。</p></li><li><p>异常终止一个连接：终止一个连接的正常方式是一方发送FIN。有事这也称为有序释放，因为所有排队数据都已发送之后才发送FIN，正常情况下没有任何数据丢失。</p><p>但是也有可能发送一个复位报文段而不是FIN来中途释放一个连接，有时也被称为异常释放。</p><p>异常释放有两个优点：</p><ul><li>丢弃任何待发数据并立即发送复位报文段（优先级高）</li><li>RST的接收方会区分另一端执行的是异常关闭还是正常关闭</li></ul></li><li><p>检测半打开连接：如果一方已经关闭或者异常终止连接，而另一方却不知道，即半打开状态。</p><p>比如，客户端因为一些原因重启，而服务器不知道TCP已经处于半打开状态，客户端再次连接，服务器将重新创建一个新的服务器程序。这样会导致服务器主机上有很多半打开的TCP连接。所以需要在重新连接的时候先发送一个RST报文段。断开之前的半打开状态的TCP连接。</p></li><li><p>向一个已经关闭的连接发送报文段。</p></li><li><p>close(sockfd)时，直接丢弃接收缓冲区未读取的数据，并给对方发一个RST。这个是由<strong>SO_LINGER</strong>选项来控制的。</p></li></ol><h2 id="几个疑问"><a href="#几个疑问" class="headerlink" title="几个疑问"></a>几个疑问</h2><h3 id="为什么需要三次握手"><a href="#为什么需要三次握手" class="headerlink" title="为什么需要三次握手"></a>为什么需要三次握手</h3><p>客户端还要再发送一次确认是为了防止<strong>已失效的连接请求报文段</strong>突然又传到了服务器，因而产生错误。</p><p>正常情况下：A发出连接请求，但因为丢失了，故而不能收到B的确认。于是A重新发出请求，然后收到确认，建立连接，数据传输完毕后，释放连接，客户端发了2个请求，一个丢掉，一个到达，没有“已失效的报文段”。</p><p>但是，某种情况下，客户端的第一个在某个节点<strong>滞留</strong>了，延误到达。本来这是一个早已失效的报文段，然而在客户端发送第二个，并且得到服务器的回应，建立了连接以后，这个报文段竟然到达了，于是服务器就认为，客户端又发送了一个新的请求，于是发送确认报文段，同意建立连接，假若没有三次的握手，那么这个连接就建立起来了（有一个请求和一个回应），此时，客户端收到服务器的确认，但服务器知道自己并没有发送建立连接的请求，因为不会理睬服务器的这个确认，于是呢，客户端也不会发送任何数据，而服务器却以为新的连接建立了起来，一直等待客户端发送数据给自己，此时服务器的资源就被白白浪费了。但是采用三次握手的话，客户端就不发送确认，那么服务器由于收不到确认，也就知道并没有要求建立连接。</p><p>因此，第三次握手，客户端发送一次确认是为了防止服务器连接开销。</p><h3 id="为什么需要四次挥手"><a href="#为什么需要四次挥手" class="headerlink" title="为什么需要四次挥手"></a>为什么需要四次挥手</h3><p>TCP建立连接要进行三次握手，而断开连接要进行四次。这是由于TCP的<strong>半关闭</strong>造成的。</p><p>因为TCP连接是全双工的(即数据可在两个方向上同时传递)，所以进行关闭时每个方向上都要单独进行关闭。这个单方向的关闭就叫半关闭。当一方完成它的数据发送任务，就发送一个FIN来向另一方通告将要终止这个方向的连接。</p><p>注意：</p><ol><li>发送了FIN只是表示这端不能继续发送数据（应用层不能再调用send发送），但是还可以接收数据。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。</li><li>在很多时候，TCP连接的断开都会由TCP层自动进行，例如你CTRL+C终止你的程序，TCP连接依然会正常关闭。</li></ol><h3 id="为什么要等待2MSL"><a href="#为什么要等待2MSL" class="headerlink" title="为什么要等待2MSL"></a>为什么要等待2MSL</h3><p>MSL即<strong>Maximum Segment Lifetime</strong>，也就是最大报文生存时间，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。引用《TCP/IP详解》中的话：“它(MSL)是任何报文段被丢弃前在网络内的最长时间”。<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc793">RFC 793</a>中规定MSL为2分钟，实际应用中常用的是30秒，1分钟和2分钟等。</p><p>TCP的TIME_WAIT状态需要等待2MSL，当TCP的一端发起主动关闭，在发出最后一个ACK包后，即第四次握手的ACK包后就进入了TIME_WAIT状态，必须在此状态上停留两倍的MSL时间，等待2MSL时间主要目的是<strong>怕最后一个ACK包对方没收到，那么对方在超时后将重发第三次握手的FIN包，主动关闭端接到重发的FIN包后可以再发一个ACK应答包。在TIME_WAIT状态时两端的端口不能使用，要等到2MSL时间结束才可继续使用。当连接处于2MSL等待阶段时任何迟到的报文段都将被丢弃</strong>。不过在实际应用中可以通过设置SO_REUSEADDR选项达到不必等待2MSL时间结束再使用此端口。</p><p>概括原因如下：</p><ol><li><strong>为了保证A发送的最后一个ACK报文段能够到达B</strong>。即最后这个确认报文段很有可能丢失，那么B会超时重传，然后A再一次确认，同时启动2MSL计时器。如果没有等待时间，发送完确认报文段就立即释放连接的话，B就无法重传了（连接已被释放，任何数据都不能出传了），因而也就收不到确认，就无法按照步骤进入CLOSE状态，即必须收到确认才能close。</li><li><strong>防止“已失效的连接请求报文段”出现在连接中</strong>。经过2MSL，那些在这个连接持续的时间内，产生的所有报文段就可以都从网络中消失。即在这个连接释放的过程中会有一些无效的报文段滞留在楼阁结点，但是呢，经过2MSL这些无效报文段就肯定可以发送到目的地，<strong>不会滞留在网络中</strong>。这样的话，在下一个连接中就不会出现上一个连接遗留下来的请求报文段了。</li></ol><p>可以看出：B结束TCP连接的时间比A早一点，因为B收到确认就断开连接了，而A还得等待2MSL。</p><h2 id="优秀资料"><a href="#优秀资料" class="headerlink" title="优秀资料"></a>优秀资料</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3c7a0771b67e">TCP状态机</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012503786/article/details/78647661">[TCP/IP]TCP状态机详解</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/guyuealian/article/details/52535294">TCP建立连接三次握手和释放连接四次握手</a></p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/TCP/" rel="tag"># TCP</a></div><div class="post-nav"><div class="post-nav-item"><a href="/Linux%E5%B7%A5%E5%85%B7/DNS-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7%20queryperf%20.html" rel="prev" title="DNS 服务器压测工具 queryperf"><i class="fa fa-chevron-left"></i> DNS 服务器压测工具 queryperf</a></div><div class="post-nav-item"> <a href="/%E6%9D%82%E8%B0%88/MAC%E5%86%99NTFS%E6%A0%BC%E5%BC%8F%E7%A7%BB%E5%8A%A8%E7%A1%AC%E7%9B%98.html" rel="next" title="MAC写NTFS格式移动硬盘">MAC写NTFS格式移动硬盘<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81MzIyNS8yOTcwMA=="></div><script src="/js/comments.js"></script></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18025897号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Chengqian</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.8.6/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.19.0/dist/instantsearch.production.min.js"></script><script src="/js/algolia-search.js"></script><script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      const visitors = document.querySelector('.leancloud_visitors');
      const url = decodeURI(visitors.id);
      const title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            const counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      const visitors = document.querySelectorAll('.leancloud_visitors');
      const entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            const target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    const { app_id, app_key, server_url } = {"enable":true,"app_id":"OxuGm1sftgvx1pybK4fNvWEI-gzGzoHsz","app_key":"wVNroDGKbkHDfo8jS43cWkzo","server_url":null,"security":false};
    function fetchData(api_server) {
      const Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    const api_server = app_id.slice(-9) === '-MdYXbMMI' ? `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com` : server_url;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script><script>
NexT.utils.loadComments('#lv-container', () => {
  window.livereOptions = {
    refer: "Linux内核/TCP状态机.html"
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
});
</script></body></html>