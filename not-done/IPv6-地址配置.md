---
title: IPv6 地址配置
date: 2018-12-16 22:48:31
categories: Linux内核
tags:
  - icmpv6
  - dhcpv6
---

# 地址自动配置

IPv6的“地址自动配置”包括以下几个先后发生的步骤:

1. 生成本地链路地址并确认其唯一性
2. 确定哪些信息应该被自动配置(地址、其 它信息还是全部)
3. 对于地址，是由无状态机制还是有状态机 制获得，或是通过两者共同获得

## 无状态和有状态

IPv6的无状态自动配置在主机侧无需进行任何配置，在路由器上也只需要很少的配置，并且不需要额外的服务器。无状态机制允许主机使用自己已知的信息和路由器通告来的信息共同生成自己的地址。**路由器通告网络前缀，来定义子网;主机生成一个“接口标识符”，来标识子网内的一个接口**。IPv6地址就由这两部分组成。**如果没有路由器的参与，主机只能生成一个本地链路地址**，这个地址对于本地网络的通讯已经足够了。

在有状态自动配置模式中，主机通过服务器获得接口地址**和/或**配置信息以及参数。服务器维护一个主机和已配置地址的数据库。有状态自动配置允许主机从服务器获得地址和/或其它配置信息。有状态自动配置和无状态自动配置是一种互补的关系。比如，主机可以通过无状态自动配置获得地址，而通过有状态自动配置获得其它信息(如网 关、DNS服务器地址等等)。

当一个网络被设计成并不关心自己的主机究竟获得了哪个地址，只要保证地址唯一且可路由就可以的情况下，无状态机制就很适合了。当需要对地址的分配进行比较严格的管理的时候，就要用到有状态自动配置了。两种配置机制可以同时使用，站点管理员通过修改Router Advertisement messages(路由器通告消息)中的相应域来决定使用哪种自动配置机制。

**无状态地址自动配置只能用于主机，而不能用于路由器。**主机的自动配置依赖于服务器发来的信息，路由器需要借助其它的配置机制。但是，路由器还是要利用本文描述的方法生成本地链路地址和进行重复地址检测的。

### 重复地址检测

为了保证在特定的链路上不出现重复地址， 节点在将**一个地址应用到接口之前**进行“重复地址检测”，无论是无状态自动配置还是有状态自动配置，都要进行重复地址检测。

## 无状态

### 无状态自动配置的目标

无状态自动配置主要的目标有以下这些:

- 将新设备连接到网络时无需手工配置
- 小型站点的同一链路上的主机之间不需要专门的服务器或路由器来进行地址分配等工作
- 含有多个网络的大型站点不应当需要有状态地址配置服务器
- 对一个站点的主机进行重新编址应该简便易行
- 系统管理员能够决定使用何种配置方式(有状态、无状态还是两者兼有)

### 无状态自动配置概述

无状态自动配置只能发生在支持多播的链路上，当支持多播的接口启用的时候，自动配置的过程就开始了。比方说，当系统启动的时候，节点(包括主机和路由器)都要生成本地链路地址。在本地链路地址被配置到接口之前，节点必须要确认这个“探测”地址没有被同一链路的其它节点所用。因此它会发送一个邻居请求报文，携带上这个“探测”地址，如果其它节点已经在使用这个“探测”地址了，就会回应一个邻居通告报文。

如果节点发现它的“探测”地址已经被别人用了，自动配置就会中止，下面就需要手工配置了。为了避免这种情况的发生，网络管理员可以提供一个**替代的接口标识符**来取代原有的接口标识符，使得自动配置过程得以继续。如果不然，就需要手工配置接口的本地链路地址和其它地址。

当节点确定它的“探测”地址是唯一的，它就将这个地址应用于接口。此时接口就具具备了IP通信的能力。

接下来的自动配置步骤是**节点得到一个路由器通告报文或者感知到本地网络中没有路由器存在**。如果本地网络中存在路由器，它们将发送路由器通告报文，指导主机使用何种类型的自动配置方式。如果本地网络中没有路由器，则应当使用有状态自动配置。

虽然路由器周期性的发送路由器通告报文，但是为了加快自动配置的速度，**主机会向“所有路由器”的多播地址发送一个或多个路由器请求报文**，路由器收到这些报文后会回应以路由器通告报文。路由器通告报文中可能包括一些用于无状态自动配置生成本地站点地址和全球单播地址的信息，比如地址前缀，有效时间等。

由于路由器周期性的发送路由器通告报文，主机会连续收到新的通告消息，**主机会处理每一个通告消息**，来进行配置状态的更改和刷新。

为了保证安全，所有的地址在分配给接口之前必须检验其唯一性。在无状态配置的情况下，地址的唯一性主要是通过接口标识符来保证的。也就是说，如果接口的本地链路地址是唯一的，那么用同一标识符生成的其它地址就不需要再进行重复地址检测了。

为了加快自动配置的速度，主机可以将生成 本地链路地址和监听路由器通告报文并行处理，以抵消路由器收到请求报文和发送通告报文之间的延迟。

配置过程如下（TBD）

### 无状态自动配置详述

自动配置在每个支持组播的接口上进行，一般 它都是在主机上进行的，但是有两个例外:

1. 路由器需要使用自动配置产生链路本地地址
2. 路由器在接口应用地址前执行DAD检测。

#### 节点配置变量

节点必须允许配置下面的自动配置相关的变量:

- DupAddrDetectTransmits

  当执行tentative address的DAD时连续发送邻居请求的数目，等于0 时表示不执行DAD，当等于1时表示发送一个邻居请求。缺省值为1，但是根据不同的链路类型可能会定义不同的值，而这些定义的值优先级高于缺省值。

- 自动配置也假设存在一个RetransTimer 定时器，该定时器在[RFC 2461](https://www.ietf.org/rfc/rfc2461.txt)中定义过。对 自动配置而言，该定时器就是为了DAD在每两个连续的邻居请求报文之间的时间延迟(如果 DupAddrDetectTransmits 大于1的话)。还有一个作用就是定义了在发送最后一个邻居请求到结束DAD过程之前这段期间的时间是多少。

#### 自动配置相关变量



## 有状态



